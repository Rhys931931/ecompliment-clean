rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    
    // 1. Define who is an Admin
    function isAdmin() { return isSignedIn() && (request.auth.token.email == 'rhys@tvmenuswvc.com' || request.auth.token.email == 'rhyshaney@gmail.com'); }

    // --- CORE USER DATA ---
    match /users/{userId} { allow read, write: if isOwner(userId) || isAdmin(); }
    match /user_secrets/{userId} { allow read, write: if isOwner(userId) || isAdmin(); }
    match /wallets/{userId} { 
      allow read: if isOwner(userId) || isAdmin(); 
      allow create: if isOwner(userId) && request.resource.data.balance == 0;
      allow update: if isAdmin(); 
    }
    match /public_profiles/{profileId} { allow read: if true; allow write: if isSignedIn(); }
    
    // --- COMPLIMENTS & SECRETS ---
    match /compliments/{complimentId} {
      // Allow public read of one doc (for search), OR admin read of the whole list.
      allow read: if true || isAdmin();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.sender_uid == request.auth.uid || resource.data.recipient_uid == request.auth.uid || request.resource.data.claimer_uid == request.auth.uid || request.resource.data.status == 'pending_approval' || request.resource.data.sender_uid != null);
      allow delete: if isOwner(resource.data.sender_uid) || isAdmin(); 
    }
    
    match /compliment_secrets/{secretId} {
      allow create: if isSignedIn();
      allow read, write: if (isSignedIn() && (resource.data.sender_uid == request.auth.uid || request.resource.data.sender_uid == request.auth.uid)) || isAdmin();
    }

    // --- BATTLE ROYALE: CLAIM REQUESTS (THE FIX) ---
    match /claim_requests/{requestId} {
      // Anyone logged in can submit a ticket
      allow create: if isSignedIn();
      // Only the Sender or the Requester can see the ticket
      allow read: if isSignedIn() && (resource.data.requester_uid == request.auth.uid || resource.data.sender_uid == request.auth.uid);
      // Sender, Admin, or Requester can update (e.g. deny, approve, cancel)
      allow update, delete: if isOwner(resource.data.requester_uid) || isAdmin() || isOwner(resource.data.sender_uid);
    }

    // --- SOCIAL ---
    match /chats/{chatId} {
      allow read, write: if isSignedIn() && (request.auth.uid in resource.data.participants || request.auth.uid in request.resource.data.participants); 
      match /messages/{messageId} { allow read, write: if isSignedIn(); }
    }
    
    match /connections/{connId} {
      allow read, write: if isSignedIn() && (request.auth.uid in resource.data.participants);
    }

    // --- COMMERCE & ADMIN ---
    match /themes/{themeId} { allow read: if true; allow write: if isAdmin(); }
    match /ads/{adId} { allow read: if true; allow create: if isSignedIn(); allow update, delete: if (resource.data.owner_email == request.auth.token.email) || isAdmin(); }
    
    match /transactions/{txnId} {
      allow read: if isOwner(resource.data.uid) || isAdmin();
      allow create: if isOwner(request.resource.data.uid);
    }
    match /orders/{orderId} {
      allow read: if isOwner(resource.data.uid) || isAdmin();
      allow create: if isOwner(request.resource.data.uid);
      allow update: if isAdmin();
    }
  }
}
